Index: config.json
===================================================================
--- config.json	(revision 2fc4e47d1461ce4003ba0ce195aad5b69d5df3d0)
+++ config.json	(revision 2fc4e47d1461ce4003ba0ce195aad5b69d5df3d0)
@@ -1,8 +0,0 @@
-{
-    "file" : "xunit.xml",
-    "consoleOutput" : {
-      "suite" : true,
-      "test" : true,
-      "fail" : false
-    }
-}
\ No newline at end of file
Index: lib/xunit-file.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- lib/xunit-file.js	(revision 2fc4e47d1461ce4003ba0ce195aad5b69d5df3d0)
+++ lib/xunit-file.js	(revision )
@@ -2,15 +2,11 @@
  * Module dependencies.
  */
 
-var mocha = require("mocha")
-  , Base = mocha.reporters.Base
-  , utils = mocha.utils
+var Base = require('./base')
+  , utils = require('../utils')
+  , fs = require('fs')
   , escape = utils.escape
-  , config = require("../config.json")
-  , fs = require("fs")
-  , filePath = process.env.XUNIT_FILE || config.file || process.cwd() + "/xunit.xml"
-  , fd = fs.openSync(filePath, 'w', 0755)
-  , consoleOutput = config.consoleOutput || {};
+  , filePath = process.env.XUNIT_FILE || process.cwd() + "/xunit.xml";
 
 /**
  * Save timer references to avoid Sinon interfering (see GH-237).
@@ -41,16 +37,10 @@
     , tests = []
     , self = this;
 
-  runner.on('suite', function(suite){
-    if(consoleOutput.suite){
-      console.log('  ' + suite.title);
-    }
-  });
+  self.fileStream = fs.createWriteStream(filePath);
 
-  runner.on('test', function(test){
-    if(consoleOutput.test){
-      console.log('  â—¦ ' + test.title);
-    }
+  runner.on('pending', function(test){
+    tests.push(test);
   });
 
   runner.on('pass', function(test){
@@ -58,62 +48,70 @@
   });
 
   runner.on('fail', function(test){
-    if(consoleOutput.fail){
-      console.log('  - ' + test.title);
-    }
     tests.push(test);
   });
 
-  runner.on('pending', function(test) {
-      tests.push(test);
-  });
-
   runner.on('end', function(){
-    
-    appendLine(tag('testsuite', {
+    self.write(tag('testsuite', {
         name: process.env.SUITE_NAME || 'Mocha Tests'
       , tests: stats.tests
       , failures: stats.failures
       , errors: stats.failures
       , skipped: stats.tests - stats.failures - stats.passes
       , timestamp: (new Date).toUTCString()
-      , time: stats.duration / 1000
+      , time: (stats.duration / 1000) || 0
     }, false));
 
-    tests.forEach(test);
-    appendLine('</testsuite>');
-    fs.closeSync(fd);
+    tests.forEach(function(t) { self.test(t); });
+    self.write('</testsuite>');
   });
 }
 
 /**
+ * Override done to close the stream (if it's a file).
+ */
+XUnitFile.prototype.done = function(failures, fn) {
+  this.fileStream.end(function() {
+    fn(failures);
+  });
+};
+
+/**
  * Inherit from `Base.prototype`.
  */
 
 XUnitFile.prototype.__proto__ = Base.prototype;
 
 /**
+ * Write out the given line
+ */
+XUnitFile.prototype.write = function(line) {
+  if (process.env.LOG_XUNIT) {
+    console.log(line);
+  }
+  this.fileStream.write(line + '\n');
+};
+
+/**
  * Output tag for the given `test.`
  */
 
-function test(test) {
+XUnitFile.prototype.test = function(test, ostream) {
   var attrs = {
       classname: test.parent.fullTitle()
     , name: test.title
-    // , time: test.duration / 1000 //old
-    ,time: test.duration ? test.duration / 1000 : 0 //new
+    , time: (test.duration / 1000) || 0
   };
 
   if ('failed' == test.state) {
     var err = test.err;
-    appendLine(tag('testcase', attrs, false, tag('failure', { message: escape(err.message) }, false, cdata(err.stack))));
+    this.write(tag('testcase', attrs, false, tag('failure', {}, false, cdata(escape(err.message) + "\n" + err.stack))));
   } else if (test.pending) {
-    delete attrs.time;
-    appendLine(tag('testcase', attrs, false, tag('skipped', {}, true)));
+    this.write(tag('testcase', attrs, false, tag('skipped', {}, true)));
   } else {
-    appendLine(tag('testcase', attrs, true) );
+    this.write(tag('testcase', attrs, true) );
   }
-}
+};
 
 /**
  * HTML tag helper.
@@ -139,11 +137,4 @@
 
 function cdata(str) {
   return '<![CDATA[' + escape(str) + ']]>';
-}
-
-function appendLine(line) {
-    if (process.env.LOG_XUNIT) {
-        console.log(line);
-    }
-    fs.writeSync(fd, line + "\n", null, 'utf8');
 }
